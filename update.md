小版本升级



```
dk ezctl upgrade default
ansible-playbook -i clusters/default/hosts -e @clusters/default/config.yml playbooks/93.upgrade.yml
2025-02-25 11:34:33 INFO cluster:default upgrade begins in 5s, press any key to abort:


PLAY [kube_master] ********************************************************************************************************************************

TASK [Gathering Facts] ****************************************************************************************************************************
ok: [10.10.10.100]

TASK [get running k8s version] ********************************************************************************************************************
changed: [10.10.10.100]

TASK [print running version] **********************************************************************************************************************
ok: [10.10.10.100] => {
    "RUNNING_VER.stdout": "Kubernetes v1.27.14"
}

TASK [get update version] *************************************************************************************************************************
changed: [10.10.10.100]

TASK [print update version] ***********************************************************************************************************************
ok: [10.10.10.100] => {
    "UPDATE_VER.stdout": "Kubernetes v1.27.16"
}

PLAY [kube_master] ********************************************************************************************************************************

TASK [kube-master : 下载 kube_master 二进制] ******************************************************************************************************
changed: [10.10.10.100] => (item=kube-apiserver)
changed: [10.10.10.100] => (item=kube-controller-manager)
changed: [10.10.10.100] => (item=kube-scheduler)
changed: [10.10.10.100] => (item=kubectl)

TASK [kube-master : 分发controller/scheduler kubeconfig配置文件] **********************************************************************************
changed: [10.10.10.100] => (item=kube-controller-manager.kubeconfig)
changed: [10.10.10.100] => (item=kube-scheduler.kubeconfig)

TASK [kube-master : 创建 kubernetes 证书签名请求] *************************************************************************************************
ok: [10.10.10.100]

TASK [kube-master : 创建 kubernetes 证书和私钥] ***************************************************************************************************
changed: [10.10.10.100]

TASK [kube-master : 创建 aggregator proxy证书签名请求] ********************************************************************************************
ok: [10.10.10.100]

TASK [kube-master : 创建 aggregator-proxy证书和私钥] **********************************************************************************************
changed: [10.10.10.100]

TASK [kube-master : 分发 kubernetes证书] **********************************************************************************************************
ok: [10.10.10.100] => (item=ca.pem)
ok: [10.10.10.100] => (item=ca-key.pem)
changed: [10.10.10.100] => (item=kubernetes.pem)
changed: [10.10.10.100] => (item=kubernetes-key.pem)
changed: [10.10.10.100] => (item=aggregator-proxy.pem)
changed: [10.10.10.100] => (item=aggregator-proxy-key.pem)

TASK [kube-master : 替换 kubeconfig 的 apiserver 地址] ********************************************************************************************
changed: [10.10.10.100] => (item=/etc/kubernetes/kube-controller-manager.kubeconfig)
changed: [10.10.10.100] => (item=/etc/kubernetes/kube-scheduler.kubeconfig)

TASK [kube-master : 创建 master 服务的 systemd unit 文件] *****************************************************************************************
ok: [10.10.10.100] => (item=kube-apiserver.service)
ok: [10.10.10.100] => (item=kube-controller-manager.service)
ok: [10.10.10.100] => (item=kube-scheduler.service)

TASK [kube-master : enable master 服务] ***********************************************************************************************************
changed: [10.10.10.100]

TASK [kube-master : 启动 master 服务] *************************************************************************************************************
changed: [10.10.10.100]

TASK [kube-master : 轮询等待kube-apiserver启动] ***************************************************************************************************
changed: [10.10.10.100]

TASK [kube-master : 轮询等待kube-controller-manager启动] ******************************************************************************************
changed: [10.10.10.100]

TASK [kube-master : 轮询等待kube-scheduler启动] ***************************************************************************************************
changed: [10.10.10.100]

TASK [kube-master : 复制kubectl.kubeconfig] *******************************************************************************************************
changed: [10.10.10.100]

TASK [kube-master : 替换 kubeconfig 的 apiserver 地址] ********************************************************************************************
ok: [10.10.10.100]

TASK [kube-master : 轮询等待master服务启动完成] ***************************************************************************************************
changed: [10.10.10.100]

TASK [kube-master : 获取user:kubernetes是否已经绑定对应角色] **************************************************************************************
changed: [10.10.10.100]

TASK [kube-node : 创建kube_node 相关目录] *********************************************************************************************************
ok: [10.10.10.100] => (item=/var/lib/kubelet)
ok: [10.10.10.100] => (item=/var/lib/kube-proxy)
ok: [10.10.10.100] => (item=/etc/cni/net.d)
ok: [10.10.10.100] => (item=/opt/cni/bin)

TASK [kube-node : 下载 kubelet,kube-proxy 二进制] *************************************************************************************************
ok: [10.10.10.100] => (item=kubectl)
changed: [10.10.10.100] => (item=kubelet)
changed: [10.10.10.100] => (item=kube-proxy)

TASK [kube-node : 下载 cni plugins 二进制文件] ****************************************************************************************************
ok: [10.10.10.100] => (item=/etc/kubeasz/bin/cni-bin/static)
ok: [10.10.10.100] => (item=/etc/kubeasz/bin/cni-bin/dummy)
changed: [10.10.10.100] => (item=/etc/kubeasz/bin/cni-bin/portmap)
changed: [10.10.10.100] => (item=/etc/kubeasz/bin/cni-bin/loopback)
ok: [10.10.10.100] => (item=/etc/kubeasz/bin/cni-bin/vlan)
ok: [10.10.10.100] => (item=/etc/kubeasz/bin/cni-bin/ipvlan)
ok: [10.10.10.100] => (item=/etc/kubeasz/bin/cni-bin/vrf)
ok: [10.10.10.100] => (item=/etc/kubeasz/bin/cni-bin/tap)
ok: [10.10.10.100] => (item=/etc/kubeasz/bin/cni-bin/ptp)
ok: [10.10.10.100] => (item=/etc/kubeasz/bin/cni-bin/host-device)
changed: [10.10.10.100] => (item=/etc/kubeasz/bin/cni-bin/bandwidth)
changed: [10.10.10.100] => (item=/etc/kubeasz/bin/cni-bin/tuning)
ok: [10.10.10.100] => (item=/etc/kubeasz/bin/cni-bin/macvlan)
ok: [10.10.10.100] => (item=/etc/kubeasz/bin/cni-bin/bridge)
ok: [10.10.10.100] => (item=/etc/kubeasz/bin/cni-bin/dhcp)
changed: [10.10.10.100] => (item=/etc/kubeasz/bin/cni-bin/host-local)
ok: [10.10.10.100] => (item=/etc/kubeasz/bin/cni-bin/sbr)
ok: [10.10.10.100] => (item=/etc/kubeasz/bin/cni-bin/firewall)

TASK [kube-node : 添加 kubectl 自动补全] **********************************************************************************************************
changed: [10.10.10.100]

TASK [kube-node : 准备kubelet 证书签名请求] *******************************************************************************************************
ok: [10.10.10.100]

TASK [kube-node : 创建 kubelet 证书与私钥] ********************************************************************************************************
changed: [10.10.10.100]

TASK [kube-node : 设置集群参数] *******************************************************************************************************************
changed: [10.10.10.100]

TASK [kube-node : 设置客户端认证参数] *************************************************************************************************************
changed: [10.10.10.100]

TASK [kube-node : 设置上下文参数] *****************************************************************************************************************
changed: [10.10.10.100]

TASK [kube-node : 选择默认上下文] *****************************************************************************************************************
changed: [10.10.10.100]

TASK [kube-node : 分发ca 证书] ********************************************************************************************************************
ok: [10.10.10.100]

TASK [kube-node : 分发kubelet 证书] ***************************************************************************************************************
changed: [10.10.10.100] => (item=kubelet.pem)
changed: [10.10.10.100] => (item=kubelet-key.pem)

TASK [kube-node : 分发kubeconfig] *****************************************************************************************************************
changed: [10.10.10.100]

TASK [kube-node : 准备 cni配置文件] ***************************************************************************************************************
changed: [10.10.10.100]

TASK [kube-node : 创建kubelet的配置文件] **********************************************************************************************************
ok: [10.10.10.100]

TASK [kube-node : 检查文件/run/systemd/resolve/resolv.conf] ***************************************************************************************
ok: [10.10.10.100]

TASK [kube-node : 创建kubelet的systemd unit文件] **************************************************************************************************
ok: [10.10.10.100]

TASK [kube-node : 开机启用kubelet 服务] ***********************************************************************************************************
changed: [10.10.10.100]

TASK [kube-node : 开启kubelet 服务] ***************************************************************************************************************
changed: [10.10.10.100]

TASK [kube-node : 分发 kube-proxy.kubeconfig配置文件] *********************************************************************************************
changed: [10.10.10.100]

TASK [kube-node : 替换 kube-proxy.kubeconfig 的 apiserver 地址] ***********************************************************************************
changed: [10.10.10.100]

TASK [kube-node : 创建kube-proxy 配置] ************************************************************************************************************
ok: [10.10.10.100]

TASK [kube-node : 创建kube-proxy 服务文件] ********************************************************************************************************
ok: [10.10.10.100]

TASK [kube-node : 开机启用kube-proxy 服务] ********************************************************************************************************
changed: [10.10.10.100]

TASK [kube-node : 开启kube-proxy 服务] ************************************************************************************************************
changed: [10.10.10.100]

TASK [kube-node : 轮询等待kube-proxy启动] *********************************************************************************************************
changed: [10.10.10.100]

TASK [kube-node : 轮询等待kubelet启动] ************************************************************************************************************
changed: [10.10.10.100]

TASK [kube-node : 轮询等待node达到Ready状态] ******************************************************************************************************
changed: [10.10.10.100]

TASK [kube-node : Setting worker role name] *******************************************************************************************************
changed: [10.10.10.100]

TASK [kube-node : Setting master role name] *******************************************************************************************************
changed: [10.10.10.100]

PLAY [kube_node] **********************************************************************************************************************************

TASK [Gathering Facts] ****************************************************************************************************************************
ok: [10.10.10.101]

TASK [kube-node : 创建kube_node 相关目录] *********************************************************************************************************
ok: [10.10.10.101] => (item=/var/lib/kubelet)
ok: [10.10.10.101] => (item=/var/lib/kube-proxy)
ok: [10.10.10.101] => (item=/etc/cni/net.d)
ok: [10.10.10.101] => (item=/opt/cni/bin)

TASK [kube-node : 下载 kubelet,kube-proxy 二进制] *************************************************************************************************
changed: [10.10.10.101] => (item=kubectl)
changed: [10.10.10.101] => (item=kubelet)
changed: [10.10.10.101] => (item=kube-proxy)

TASK [kube-node : 下载 cni plugins 二进制文件] ****************************************************************************************************
ok: [10.10.10.101] => (item=/etc/kubeasz/bin/cni-bin/static)
ok: [10.10.10.101] => (item=/etc/kubeasz/bin/cni-bin/dummy)
changed: [10.10.10.101] => (item=/etc/kubeasz/bin/cni-bin/portmap)
changed: [10.10.10.101] => (item=/etc/kubeasz/bin/cni-bin/loopback)
ok: [10.10.10.101] => (item=/etc/kubeasz/bin/cni-bin/vlan)
ok: [10.10.10.101] => (item=/etc/kubeasz/bin/cni-bin/ipvlan)
ok: [10.10.10.101] => (item=/etc/kubeasz/bin/cni-bin/vrf)
ok: [10.10.10.101] => (item=/etc/kubeasz/bin/cni-bin/tap)
ok: [10.10.10.101] => (item=/etc/kubeasz/bin/cni-bin/ptp)
ok: [10.10.10.101] => (item=/etc/kubeasz/bin/cni-bin/host-device)
changed: [10.10.10.101] => (item=/etc/kubeasz/bin/cni-bin/bandwidth)
changed: [10.10.10.101] => (item=/etc/kubeasz/bin/cni-bin/tuning)
ok: [10.10.10.101] => (item=/etc/kubeasz/bin/cni-bin/macvlan)
ok: [10.10.10.101] => (item=/etc/kubeasz/bin/cni-bin/bridge)
ok: [10.10.10.101] => (item=/etc/kubeasz/bin/cni-bin/dhcp)
changed: [10.10.10.101] => (item=/etc/kubeasz/bin/cni-bin/host-local)
ok: [10.10.10.101] => (item=/etc/kubeasz/bin/cni-bin/sbr)
ok: [10.10.10.101] => (item=/etc/kubeasz/bin/cni-bin/firewall)

TASK [kube-node : 添加 kubectl 自动补全] **********************************************************************************************************
ok: [10.10.10.101]

TASK [kube-node : 准备kubelet 证书签名请求] *******************************************************************************************************
ok: [10.10.10.101]

TASK [kube-node : 创建 kubelet 证书与私钥] ********************************************************************************************************
changed: [10.10.10.101]

TASK [kube-node : 设置集群参数] *******************************************************************************************************************
changed: [10.10.10.101]

TASK [kube-node : 设置客户端认证参数] *************************************************************************************************************
changed: [10.10.10.101]

TASK [kube-node : 设置上下文参数] *****************************************************************************************************************
changed: [10.10.10.101]

TASK [kube-node : 选择默认上下文] *****************************************************************************************************************
changed: [10.10.10.101]

TASK [kube-node : 分发ca 证书] ********************************************************************************************************************
ok: [10.10.10.101]

TASK [kube-node : 分发kubelet 证书] ***************************************************************************************************************
changed: [10.10.10.101] => (item=kubelet.pem)
changed: [10.10.10.101] => (item=kubelet-key.pem)

TASK [kube-node : 分发kubeconfig] *****************************************************************************************************************
changed: [10.10.10.101]

TASK [kube-node : 准备 cni配置文件] ***************************************************************************************************************
changed: [10.10.10.101]

TASK [kube-node : 创建kubelet的配置文件] **********************************************************************************************************
ok: [10.10.10.101]

TASK [kube-node : 检查文件/run/systemd/resolve/resolv.conf] ***************************************************************************************
ok: [10.10.10.101]

TASK [kube-node : 创建kubelet的systemd unit文件] **************************************************************************************************
ok: [10.10.10.101]

TASK [kube-node : 开机启用kubelet 服务] ***********************************************************************************************************
changed: [10.10.10.101]

TASK [kube-node : 开启kubelet 服务] ***************************************************************************************************************
changed: [10.10.10.101]

TASK [kube-node : 分发 kube-proxy.kubeconfig配置文件] *********************************************************************************************
changed: [10.10.10.101]

TASK [kube-node : 替换 kube-proxy.kubeconfig 的 apiserver 地址] ***********************************************************************************
changed: [10.10.10.101]

TASK [kube-node : 创建kube-proxy 配置] ************************************************************************************************************
ok: [10.10.10.101]

TASK [kube-node : 创建kube-proxy 服务文件] ********************************************************************************************************
ok: [10.10.10.101]

TASK [kube-node : 开机启用kube-proxy 服务] ********************************************************************************************************
changed: [10.10.10.101]

TASK [kube-node : 开启kube-proxy 服务] ************************************************************************************************************
changed: [10.10.10.101]

TASK [kube-node : 轮询等待kube-proxy启动] *********************************************************************************************************
changed: [10.10.10.101]

TASK [kube-node : 轮询等待kubelet启动] ************************************************************************************************************
changed: [10.10.10.101]

TASK [kube-node : 轮询等待node达到Ready状态] ******************************************************************************************************
changed: [10.10.10.101]

TASK [kube-node : Setting worker role name] *******************************************************************************************************
changed: [10.10.10.101]

PLAY RECAP ****************************************************************************************************************************************
10.10.10.100               : ok=53   changed=38   unreachable=0    failed=0    skipped=36   rescued=0    ignored=0   
10.10.10.101               : ok=30   changed=20   unreachable=0    failed=0    skipped=3    rescued=0    ignored=0
```

