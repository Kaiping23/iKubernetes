# 安装ansible
yum -y install ansible

export release=3.6.2
wget https://github.com/easzlab/kubeasz/releases/download/${release}/ezdown
chmod +x ./ezdown

./ezdown -D -k v1.27.14

./ezdown -S

docker exec -it kubeasz ezctl start-aio
# 如果安装失败，查看日志排除后，使用如下命令重新安装aio集群
# docker exec -it kubeasz ezctl setup default all

$ source ~/.bashrc
$ kubectl version         # 验证集群版本     
$ kubectl get node        # 验证节点就绪 (Ready) 状态
$ kubectl get pod -A      # 验证集群pod状态，默认已安装网络插件、coredns、metrics-server等
$ kubectl get svc -A      # 验证集群服务状态


# 添加节点 
# https://github.com/easzlab/kubeasz/blob/master/docs/op/op-node.md

目录

1.增加 kube_node 节点
2.增加非标准ssh端口节点
3.删除 kube_node 节点
1.增加 kube_node 节点
新增kube_node节点大致流程为：(参考ezctl 里面add-node函数 和 playbooks/22.addnode.yml)

[可选]新节点安装 chrony 时间同步
新节点预处理 prepare
新节点安装 container runtime
新节点安装 kube_node 服务
新节点安装网络插件相关
操作步骤
执行如下 (假设待增加节点为 192.168.1.11，k8s集群名为 test-k8s)：

# ssh 免密码登录
$ ssh-copy-id 192.168.1.11

# 新增节点
$ ezctl add-node test-k8s 192.168.1.11

```
docker exec -it kubeasz ezctl add-node default 10.10.10.101 k8s_nodename=worker-01
2025-02-25 10:41:13 INFO add 10.10.10.101 into 'kube_node' group
2025-02-25 10:41:13 INFO start to add a work node:10.10.10.101 into cluster:default

PLAY [10.10.10.101] *******************************************************************************************************************************

TASK [Gathering Facts] ****************************************************************************************************************************
ok: [10.10.10.101]

TASK [prepare : 禁用系统 swap] ********************************************************************************************************************
changed: [10.10.10.101]

TASK [prepare : 删除fstab swap 相关配置] **********************************************************************************************************
ok: [10.10.10.101]

TASK [prepare : 加载内核模块] *********************************************************************************************************************
ok: [10.10.10.101] => (item=br_netfilter)
ok: [10.10.10.101] => (item=ip_vs)
ok: [10.10.10.101] => (item=ip_vs_rr)
ok: [10.10.10.101] => (item=ip_vs_wrr)
ok: [10.10.10.101] => (item=ip_vs_sh)
ok: [10.10.10.101] => (item=nf_conntrack)

TASK [prepare : 尝试加载nf_conntrack_ipv4] ********************************************************************************************************
changed: [10.10.10.101]

TASK [prepare : 启用systemd自动加载模块服务] ******************************************************************************************************
ok: [10.10.10.101]

TASK [prepare : 增加内核模块开机加载配置] *********************************************************************************************************
ok: [10.10.10.101]

TASK [prepare : 设置系统参数] *********************************************************************************************************************
ok: [10.10.10.101]

TASK [prepare : 查看是否需要设置 fs.may_detach_mounts] ********************************************************************************************
ok: [10.10.10.101]

TASK [prepare : 查看是否需要设置 net.ipv4.tcp_tw_recycle] *****************************************************************************************
ok: [10.10.10.101]

TASK [prepare : 生效系统参数] *********************************************************************************************************************
changed: [10.10.10.101]

TASK [prepare : 创建 systemd 配置目录] ************************************************************************************************************
ok: [10.10.10.101]

TASK [prepare : 设置系统 ulimits] *****************************************************************************************************************
ok: [10.10.10.101]

TASK [prepare : 把SCTP列入内核模块黑名单] *********************************************************************************************************
ok: [10.10.10.101]

TASK [prepare : prepare some dirs] ****************************************************************************************************************
changed: [10.10.10.101] => (item=/opt/kube/bin)
changed: [10.10.10.101] => (item=/etc/kubernetes/ssl)
ok: [10.10.10.101] => (item=/root/.kube)

TASK [prepare : 写入环境变量$PATH] ****************************************************************************************************************
ok: [10.10.10.101]

TASK [prepare : 添加 local registry hosts 解析] ***************************************************************************************************
ok: [10.10.10.101]

TASK [prepare : 设置 k8s_nodename 在 master[0] 节点 /etc/hosts 地址解析] **************************************************************************
ok: [10.10.10.101 -> 10.10.10.100]

TASK [prepare : 获取 master[0] 节点由kubeasz 创建的 /etc/hosts 地址解析] **************************************************************************
changed: [10.10.10.101 -> 10.10.10.100]

TASK [prepare : 删除 master[0] 节点由kubeasz 创建的 /etc/hosts 地址解析] **************************************************************************
changed: [10.10.10.101 -> 10.10.10.100]

TASK [prepare : 设置 k8s_nodename 在所有节点的 /etc/hosts 地址解析] *******************************************************************************
changed: [10.10.10.101 -> 10.10.10.100] => (item=10.10.10.100)
changed: [10.10.10.101] => (item=10.10.10.101)
ok: [10.10.10.101 -> 10.10.10.100] => (item=10.10.10.100)

TASK [containerd : 获取是否已经安装containerd] ****************************************************************************************************
changed: [10.10.10.101]

TASK [containerd : 准备containerd相关目录] ********************************************************************************************************
changed: [10.10.10.101] => (item=/opt/kube/bin/containerd-bin)
changed: [10.10.10.101] => (item=/etc/containerd)

TASK [containerd : 加载内核模块 overlay] **********************************************************************************************************
changed: [10.10.10.101]

TASK [containerd : 下载 containerd 二进制文件] ****************************************************************************************************
changed: [10.10.10.101] => (item=/etc/kubeasz/bin/containerd-bin/containerd-shim-runc-v1)
changed: [10.10.10.101] => (item=/etc/kubeasz/bin/containerd-bin/containerd-shim-runc-v2)
changed: [10.10.10.101] => (item=/etc/kubeasz/bin/containerd-bin/containerd-stress)
changed: [10.10.10.101] => (item=/etc/kubeasz/bin/containerd-bin/runc)
changed: [10.10.10.101] => (item=/etc/kubeasz/bin/containerd-bin/containerd)
changed: [10.10.10.101] => (item=/etc/kubeasz/bin/containerd-bin/ctr)
changed: [10.10.10.101] => (item=/etc/kubeasz/bin/containerd-bin/containerd-shim)

TASK [containerd : 下载 crictl] *******************************************************************************************************************
changed: [10.10.10.101]

TASK [containerd : 添加 crictl 自动补全] **********************************************************************************************************
ok: [10.10.10.101]

TASK [containerd : 创建 containerd 配置文件] ******************************************************************************************************
changed: [10.10.10.101]

TASK [containerd : 创建systemd unit文件] **********************************************************************************************************
changed: [10.10.10.101]

TASK [containerd : 创建 crictl 配置] **************************************************************************************************************
changed: [10.10.10.101]

TASK [containerd : 开机启用 containerd 服务] ******************************************************************************************************
changed: [10.10.10.101]

TASK [containerd : 开启 containerd 服务] **********************************************************************************************************
changed: [10.10.10.101]

TASK [containerd : 轮询等待containerd服务运行] ****************************************************************************************************
changed: [10.10.10.101]

TASK [kube-lb : prepare some dirs] ****************************************************************************************************************
changed: [10.10.10.101] => (item=/etc/kube-lb/sbin)
changed: [10.10.10.101] => (item=/etc/kube-lb/logs)
changed: [10.10.10.101] => (item=/etc/kube-lb/conf)

TASK [kube-lb : 下载二进制文件kube-lb(nginx)] *****************************************************************************************************
changed: [10.10.10.101]

TASK [kube-lb : 创建kube-lb的配置文件] ************************************************************************************************************
changed: [10.10.10.101]

TASK [kube-lb : 创建kube-lb的systemd unit文件] ****************************************************************************************************
changed: [10.10.10.101]

TASK [kube-lb : 开机启用kube-lb服务] **************************************************************************************************************
changed: [10.10.10.101]

TASK [kube-lb : 开启kube-lb服务] ******************************************************************************************************************
changed: [10.10.10.101]

TASK [kube-lb : 以轮询的方式等待kube-lb服务启动] **************************************************************************************************
changed: [10.10.10.101]

TASK [kube-node : 创建kube_node 相关目录] *********************************************************************************************************
changed: [10.10.10.101] => (item=/var/lib/kubelet)
changed: [10.10.10.101] => (item=/var/lib/kube-proxy)
ok: [10.10.10.101] => (item=/etc/cni/net.d)
changed: [10.10.10.101] => (item=/opt/cni/bin)

TASK [kube-node : 下载 kubelet,kube-proxy 二进制] *************************************************************************************************
changed: [10.10.10.101] => (item=kubectl)
changed: [10.10.10.101] => (item=kubelet)
changed: [10.10.10.101] => (item=kube-proxy)

TASK [kube-node : 下载 cni plugins 二进制文件] ****************************************************************************************************
changed: [10.10.10.101] => (item=/etc/kubeasz/bin/cni-bin/static)
changed: [10.10.10.101] => (item=/etc/kubeasz/bin/cni-bin/dummy)
changed: [10.10.10.101] => (item=/etc/kubeasz/bin/cni-bin/portmap)
changed: [10.10.10.101] => (item=/etc/kubeasz/bin/cni-bin/loopback)
changed: [10.10.10.101] => (item=/etc/kubeasz/bin/cni-bin/vlan)
changed: [10.10.10.101] => (item=/etc/kubeasz/bin/cni-bin/ipvlan)
changed: [10.10.10.101] => (item=/etc/kubeasz/bin/cni-bin/vrf)
changed: [10.10.10.101] => (item=/etc/kubeasz/bin/cni-bin/tap)
changed: [10.10.10.101] => (item=/etc/kubeasz/bin/cni-bin/ptp)
changed: [10.10.10.101] => (item=/etc/kubeasz/bin/cni-bin/host-device)
changed: [10.10.10.101] => (item=/etc/kubeasz/bin/cni-bin/bandwidth)
changed: [10.10.10.101] => (item=/etc/kubeasz/bin/cni-bin/tuning)
changed: [10.10.10.101] => (item=/etc/kubeasz/bin/cni-bin/macvlan)
changed: [10.10.10.101] => (item=/etc/kubeasz/bin/cni-bin/bridge)
changed: [10.10.10.101] => (item=/etc/kubeasz/bin/cni-bin/dhcp)
changed: [10.10.10.101] => (item=/etc/kubeasz/bin/cni-bin/host-local)
changed: [10.10.10.101] => (item=/etc/kubeasz/bin/cni-bin/sbr)
changed: [10.10.10.101] => (item=/etc/kubeasz/bin/cni-bin/firewall)

TASK [kube-node : 添加 kubectl 自动补全] **********************************************************************************************************
ok: [10.10.10.101]

TASK [kube-node : 准备kubelet 证书签名请求] *******************************************************************************************************
ok: [10.10.10.101]

TASK [kube-node : 创建 kubelet 证书与私钥] ********************************************************************************************************
changed: [10.10.10.101]

TASK [kube-node : 设置集群参数] *******************************************************************************************************************
changed: [10.10.10.101]

TASK [kube-node : 设置客户端认证参数] *************************************************************************************************************
changed: [10.10.10.101]

TASK [kube-node : 设置上下文参数] *****************************************************************************************************************
changed: [10.10.10.101]

TASK [kube-node : 选择默认上下文] *****************************************************************************************************************
changed: [10.10.10.101]

TASK [kube-node : 分发ca 证书] ********************************************************************************************************************
changed: [10.10.10.101]

TASK [kube-node : 分发kubelet 证书] ***************************************************************************************************************
changed: [10.10.10.101] => (item=kubelet.pem)
changed: [10.10.10.101] => (item=kubelet-key.pem)

TASK [kube-node : 分发kubeconfig] *****************************************************************************************************************
changed: [10.10.10.101]

TASK [kube-node : 准备 cni配置文件] ***************************************************************************************************************
changed: [10.10.10.101]

TASK [kube-node : 创建kubelet的配置文件] **********************************************************************************************************
changed: [10.10.10.101]

TASK [kube-node : 检查文件/run/systemd/resolve/resolv.conf] ***************************************************************************************
ok: [10.10.10.101]

TASK [kube-node : 创建kubelet的systemd unit文件] **************************************************************************************************
changed: [10.10.10.101]

TASK [kube-node : 开机启用kubelet 服务] ***********************************************************************************************************
changed: [10.10.10.101]

TASK [kube-node : 开启kubelet 服务] ***************************************************************************************************************
changed: [10.10.10.101]

TASK [kube-node : 分发 kube-proxy.kubeconfig配置文件] *********************************************************************************************
changed: [10.10.10.101]

TASK [kube-node : 替换 kube-proxy.kubeconfig 的 apiserver 地址] ***********************************************************************************
changed: [10.10.10.101]

TASK [kube-node : 创建kube-proxy 配置] ************************************************************************************************************
changed: [10.10.10.101]

TASK [kube-node : 创建kube-proxy 服务文件] ********************************************************************************************************
changed: [10.10.10.101]

TASK [kube-node : 开机启用kube-proxy 服务] ********************************************************************************************************
changed: [10.10.10.101]

TASK [kube-node : 开启kube-proxy 服务] ************************************************************************************************************
changed: [10.10.10.101]

TASK [kube-node : 轮询等待kube-proxy启动] *********************************************************************************************************
changed: [10.10.10.101]

TASK [kube-node : 轮询等待kubelet启动] ************************************************************************************************************
changed: [10.10.10.101]

TASK [kube-node : 轮询等待node达到Ready状态] ******************************************************************************************************
changed: [10.10.10.101]

TASK [kube-node : Setting worker role name] *******************************************************************************************************
changed: [10.10.10.101]

TASK [calico : 创建calico 证书请求] ***************************************************************************************************************
ok: [10.10.10.101]

TASK [calico : 创建 calico证书和私钥] *************************************************************************************************************
changed: [10.10.10.101]

TASK [calico : 删除旧 calico-etcd-secrets] ********************************************************************************************************
changed: [10.10.10.101]

TASK [calico : 创建 calico-etcd-secrets] **********************************************************************************************************
changed: [10.10.10.101]

TASK [calico : 配置 calico DaemonSet yaml文件] ****************************************************************************************************
ok: [10.10.10.101]

TASK [calico : 运行 calico网络] *******************************************************************************************************************
changed: [10.10.10.101]

TASK [calico : 在节点创建相关目录] ****************************************************************************************************************
changed: [10.10.10.101] => (item=/etc/calico/ssl)

TASK [calico : 分发calico证书相关] ****************************************************************************************************************
changed: [10.10.10.101] => (item=ca.pem)
changed: [10.10.10.101] => (item=calico.pem)
changed: [10.10.10.101] => (item=calico-key.pem)

TASK [calico : 删除默认cni配置] *******************************************************************************************************************
changed: [10.10.10.101]

TASK [calico : 下载calicoctl 客户端] **************************************************************************************************************
changed: [10.10.10.101] => (item=calicoctl)

TASK [calico : 准备 calicoctl配置文件] ************************************************************************************************************
changed: [10.10.10.101]

TASK [calico : 轮询等待calico-node 运行] **********************************************************************************************************
changed: [10.10.10.101]

PLAY RECAP ****************************************************************************************************************************************
10.10.10.101               : ok=81   changed=61   unreachable=0    failed=0    skipped=178  rescued=0    ignored=0  
```



# 同理，重复上面步骤再新增节点并自定义nodename
$ ezctl add-node test-k8s 192.168.1.12 k8s_nodename=worker-03
验证
# 验证新节点状态
$ kubectl get node

# 验证新节点的网络插件calico 或flannel 的Pod 状态
$ kubectl get pod -n kube-system

# 验证新建pod能否调度到新节点，略
2.增加非标准ssh端口节点
假设待添加节点192.168.2.1，ssh 端口 10022；然后执行

$ ssh-copy-id -p 10022 192.168.2.1
$ ezctl add-node test-k8s 192.168.2.1 ansible_ssh_port=10022
注意：如果在添加节点时需要设置其他个性化变量，可以同理在后面不断添加
3.删除 kube_node 节点
删除 node 节点流程：(参考ezctl 里面del-node函数 和 playbooks/32.delnode.yml)

检测是否可以删除
迁移节点上的 pod
删除 node 相关服务及文件
从集群删除 node
操作步骤
$ ezctl del-node test-k8s 192.168.1.11 # 假设待删除节点为 192.168.1.11

docker exec -it kubeasz ezctl 


# test k8s
kubectl run -it test-dns --image=registry.cn-hangzhou.aliyuncs.com/liangkaiping/lkp:busy-latest-20241111 --restart=Never --rm -- nslookup kubernetes.default
